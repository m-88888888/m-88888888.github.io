<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>deviseを使わないでログイン機能を実装する - hachi&#39;s blog</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="deviseを使わないでログイン機能を実装する" />
<meta property="og:description" content="ポートフォリオの作成時にログイン機能を簡単に実装できるdeviseというgemを利用してみました。 コマンドを叩くだけで簡単なログイン機能を実装できるという、scaffoldに近い部分があるので、裏の動きを理解するためにRailsチュートリアルの内容を参考に、deviseが担っている処理を学習し直しました。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://m-88888888.github.io/posts/devise%E3%82%92%E4%BD%BF%E3%82%8F%E3%81%AA%E3%81%84%E3%81%A7%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3%E6%A9%9F%E8%83%BD%E3%82%92%E5%AE%9F%E8%A3%85%E3%81%99%E3%82%8B/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-10-01T00:03:15&#43;09:00" />
<meta property="article:modified_time" content="2019-10-01T00:03:15&#43;09:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="deviseを使わないでログイン機能を実装する"/>
<meta name="twitter:description" content="ポートフォリオの作成時にログイン機能を簡単に実装できるdeviseというgemを利用してみました。 コマンドを叩くだけで簡単なログイン機能を実装できるという、scaffoldに近い部分があるので、裏の動きを理解するためにRailsチュートリアルの内容を参考に、deviseが担っている処理を学習し直しました。"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://m-88888888.github.iocss/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://m-88888888.github.iocss/main.css" />
	<link rel="stylesheet" type="text/css" href="https://m-88888888.github.iocss/custom.css" />
	<link rel="stylesheet" type="text/css" href="https://m-88888888.github.iocss/dark.css"  />
	<link rel="stylesheet" type="text/css" href="https://m-88888888.github.iocss/custom-dark.css"  />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<script src="https://m-88888888.github.iojs/main.js"></script>
	<script src="https://m-88888888.github.iojs/abc.js"></script>
	<script src="https://m-88888888.github.iojs/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://m-88888888.github.io">
	<h1 class="site-title"><a href="https://m-88888888.github.io">hachi&#39;s blog</a></h1>
	<div class="site-description"><h2>いろいろアウトプット</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/m-88888888" title="Github"><i data-feather="github"></i></a><a href="https://twitter.com/hachi88_10" title="Twitter"><i data-feather="twitter"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">deviseを使わないでログイン機能を実装する</h1>
			<div class="meta">Posted at &mdash; Oct 1, 2019</div>
		</div>

		<div class="markdown">
			<p>ポートフォリオの作成時にログイン機能を簡単に実装できる<code>devise</code>というgemを利用してみました。
コマンドを叩くだけで簡単なログイン機能を実装できるという、scaffoldに近い部分があるので、裏の動きを理解するためにRailsチュートリアルの内容を参考に、deviseが担っている処理を学習し直しました。</p>
<h1 id="やること">やること</h1>
<h2 id="1-サインアップ機能">1. サインアップ機能</h2>
<p>ユーザー登録時に最低限必要な情報は次の３つ。</p>
<ul>
<li>ユーザー名</li>
<li>メールアドレス</li>
<li>パスワード</li>
</ul>
<p>サインアップ機能で重要なのは、パスワードを平文の状態で触れないこと。
そこでパスワードをハッシュ化（規則性のない文字列）に変換してからDBに保存させるようにする。</p>
<p><code>BCrypt</code>というgemを使ってパスワードのハッシュ化に関する処理を行う。
主に以下の２つのメソッドが使える様になる。</p>
<ol>
<li>
<p>has_secure_password
セキュアにハッシュ化した不可逆なパスワードをDBのpassword_digestカラムに保存することができる。
また、passwordとpassword_confirmationを使える様になる</p>
</li>
<li>
<p>authenticate
引数の文字列が保存したパスワードと一致するとそれに紐づくUserオブジェクトを、一致しなければfalseを返す</p>
</li>
</ol>
<h3 id="userモデルとテーブルの作成">Userモデルとテーブルの作成</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#586e75"># create_table.rb</span>
<span style="color:#719e07">class</span> <span style="color:#268bd2">CreateUsers</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">ActiveRecord</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Migration</span><span style="color:#719e07">[</span><span style="color:#2aa198">5</span><span style="color:#719e07">.</span><span style="color:#2aa198">2</span><span style="color:#719e07">]</span>
　　<span style="color:#719e07">def</span> <span style="color:#268bd2">change</span>
　　　　create_table <span style="color:#2aa198">:users</span> <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>t<span style="color:#719e07">|</span>
　　　　　　t<span style="color:#719e07">.</span>string <span style="color:#2aa198">:username</span>, <span style="color:#2aa198">null</span>: <span style="color:#719e07">false</span>
　　　　　　t<span style="color:#719e07">.</span>string <span style="color:#2aa198">:email</span>, <span style="color:#2aa198">null</span>: <span style="color:#719e07">false</span>
　　　　　　t<span style="color:#719e07">.</span>string <span style="color:#2aa198">:password_digest</span>
 
　　　　　　t<span style="color:#719e07">.</span>timestamps
　　　　<span style="color:#719e07">end</span>
　　<span style="color:#719e07">end</span>
<span style="color:#719e07">end</span>
</code></pre></div><div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#586e75"># User.rb</span>
<span style="color:#719e07">class</span> <span style="color:#268bd2">User</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">ApplicationRecord</span>
　　before_save { <span style="color:#b58900">self</span><span style="color:#719e07">.</span>email <span style="color:#719e07">=</span> email<span style="color:#719e07">.</span>downcase }　<span style="color:#586e75">#DB保存前に小文字に変換</span>
 
　　validates <span style="color:#2aa198">:username</span>,<span style="color:#2aa198">presence</span>: <span style="color:#719e07">true</span>
　　validates <span style="color:#2aa198">:email</span>,
　　　  　　　　 <span style="color:#2aa198">presence</span>: <span style="color:#719e07">true</span>,
  　  　　　    <span style="color:#2aa198">uniqueness</span>: { <span style="color:#2aa198">case_sensitive</span>: <span style="color:#719e07">false</span> },　<span style="color:#586e75">#大文字・小文字の区別なし</span>
 　　　　       <span style="color:#b58900">format</span>: { <span style="color:#2aa198">with</span>: <span style="color:#dc322f">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span> } <span style="color:#586e75">#「/i」は大文字・小文字を区別せずにマッチングさせる正規表現</span>
 
 　　has_secure_password
<span style="color:#719e07">end</span>
</code></pre></div><p>メールアドレスの大文字・小文字の区別は、メールサーバーによって変わるので小文字でフォーマットを統一させる。</p>
<h3 id="userコントローラーの作成">Userコントローラーの作成</h3>
<p>ひとまずはサインアップとサインインの画面を作るだけなのでnewとcreateアクションを作成する</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#719e07">class</span> <span style="color:#268bd2">UsersController</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">ApplicationController</span>
　　<span style="color:#719e07">def</span> <span style="color:#268bd2">new</span>
　　  @user <span style="color:#719e07">=</span> <span style="color:#cb4b16">User</span><span style="color:#719e07">.</span>new
　  <span style="color:#719e07">end</span>
 
  <span style="color:#719e07">def</span> <span style="color:#268bd2">create</span>
    @user <span style="color:#719e07">=</span> <span style="color:#cb4b16">User</span><span style="color:#719e07">.</span>new(user_params)
    <span style="color:#719e07">if</span> @user<span style="color:#719e07">.</span>save
      redirect_to root_path
　　 <span style="color:#719e07">else</span>
      render <span style="color:#2aa198">action</span>: <span style="color:#2aa198">&#34;new&#34;</span>
　　 <span style="color:#719e07">end</span>
 　<span style="color:#719e07">end</span>
 
　　privatef
 
　　<span style="color:#719e07">def</span> <span style="color:#268bd2">user_params</span>
　　  params<span style="color:#719e07">.</span>require(<span style="color:#2aa198">:user</span>)<span style="color:#719e07">.</span>permit(<span style="color:#2aa198">:username</span>, <span style="color:#2aa198">:email</span>, <span style="color:#2aa198">:password</span>, <span style="color:#2aa198">:password_confirmation</span>)
 　 <span style="color:#719e07">end</span>
<span style="color:#719e07">end</span>
</code></pre></div><h3 id="サインアップ画面の作成">サインアップ画面の作成</h3>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">h1 <span style="color:#cb4b16">Login</span>

<span style="color:#719e07">=</span> form_with <span style="color:#2aa198">model</span>: @user <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>f<span style="color:#719e07">|</span>
  <span style="color:#719e07">.</span>form<span style="color:#719e07">-</span>group
    <span style="color:#719e07">=</span> f<span style="color:#719e07">.</span>label <span style="color:#2aa198">:name</span>, <span style="color:#2aa198">&#39;Name&#39;</span>
    <span style="color:#719e07">=</span> f<span style="color:#719e07">.</span>text_field <span style="color:#2aa198">:name</span>, <span style="color:#2aa198">class</span>: <span style="color:#2aa198">&#39;form-control&#39;</span>
  <span style="color:#719e07">.</span>form<span style="color:#719e07">-</span>group
    <span style="color:#719e07">=</span> f<span style="color:#719e07">.</span>label <span style="color:#2aa198">:email</span>, <span style="color:#2aa198">&#39;Email&#39;</span>
    <span style="color:#719e07">=</span> f<span style="color:#719e07">.</span>text_field <span style="color:#2aa198">:email</span>, <span style="color:#2aa198">class</span>: <span style="color:#2aa198">&#39;form-control&#39;</span>
  <span style="color:#719e07">.</span>form<span style="color:#719e07">-</span>group
    <span style="color:#719e07">=</span> f<span style="color:#719e07">.</span>label <span style="color:#2aa198">:password</span>, <span style="color:#2aa198">&#39;Password&#39;</span>
    <span style="color:#719e07">=</span> f<span style="color:#719e07">.</span>password_field <span style="color:#2aa198">:password</span>, <span style="color:#2aa198">class</span>: <span style="color:#2aa198">&#39;form-control&#39;</span>
  <span style="color:#719e07">.</span>form<span style="color:#719e07">-</span>group
    <span style="color:#719e07">=</span> f<span style="color:#719e07">.</span>label <span style="color:#2aa198">:password_confirmation</span>, <span style="color:#2aa198">&#39;Password_Confirmation&#39;</span>
    <span style="color:#719e07">=</span> f<span style="color:#719e07">.</span>password_field <span style="color:#2aa198">:password_confirmation</span>, <span style="color:#2aa198">class</span>: <span style="color:#2aa198">&#39;form-control&#39;</span>
  <span style="color:#719e07">=</span> f<span style="color:#719e07">.</span>submit

</code></pre></div><p>サインアップの機能完了！</p>
<h2 id="2ログイン機能">2.ログイン機能</h2>
<p>sessionコントローラーを作成</p>
<ul>
<li>new・・・ログインフォームの作成</li>
<li>create・・・ログイン処理</li>
<li>destroy・・・ログアウト処理</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#586e75"># sessions_controller.rb</span>
<span style="color:#719e07">class</span> <span style="color:#268bd2">SessionsController</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">ApplicationController</span>
  <span style="color:#719e07">def</span> <span style="color:#268bd2">new</span>
  <span style="color:#719e07">end</span>

  <span style="color:#719e07">def</span> <span style="color:#268bd2">create</span>
    user <span style="color:#719e07">=</span> <span style="color:#cb4b16">User</span><span style="color:#719e07">.</span>find_by(<span style="color:#2aa198">email</span>: params<span style="color:#719e07">[</span><span style="color:#2aa198">:session</span><span style="color:#719e07">][</span><span style="color:#2aa198">:email</span><span style="color:#719e07">].</span>downcase)
    <span style="color:#586e75">#セッション情報に含まれているメールアドレスをもとに、Usersテーブルに保存されているUserオブジェクトを抽出</span>

    <span style="color:#719e07">if</span> user <span style="color:#719e07">&amp;&amp;</span> user<span style="color:#719e07">.</span>authenticate(params<span style="color:#719e07">[</span><span style="color:#2aa198">:session</span><span style="color:#719e07">][</span><span style="color:#2aa198">:password</span><span style="color:#719e07">]</span>)
      <span style="color:#586e75"># Userオブジェクトが抽出できる（つまり、Usersテーブルに存在している）かつ</span>
　　　 <span style="color:#586e75"># paramsで送られてきたセッションの中のパスワード（ハッシュ化されている）が</span>
      <span style="color:#586e75"># DB内のハッシュ化されたpassword_digestカラムの値と一致しているかどうか検証することで、ユーザーを識別</span>
      log_in user
      redirect_to <span style="color:#586e75"># ログイン後の遷移先_path</span>
    <span style="color:#719e07">else</span>
      flash<span style="color:#719e07">.</span>now<span style="color:#719e07">[</span><span style="color:#2aa198">:danger</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;Invalid email/password combination&#39;</span>
      render <span style="color:#2aa198">&#39;new&#39;</span>
    <span style="color:#719e07">end</span>
  <span style="color:#719e07">end</span>
 
  <span style="color:#719e07">def</span> <span style="color:#268bd2">destroy</span>
    log_out
    redirect_to root_url
  <span style="color:#719e07">end</span>
<span style="color:#719e07">end</span>
</code></pre></div><p>ヘルパーメソッドに処理を追加</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#719e07">module</span> SessionsHelper
    <span style="color:#586e75"># ユーザーのブラウザ内にある一時cookieに暗号化済みのユーザーIDを作成する</span>
    <span style="color:#719e07">def</span> <span style="color:#268bd2">log_in</span>(user)
        session<span style="color:#719e07">[</span><span style="color:#2aa198">:user_id</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> user<span style="color:#719e07">.</span>id
    <span style="color:#719e07">end</span>
     
      <span style="color:#586e75"># 現在ログインしているユーザーを返す (ユーザーがログイン中の場合のみ)</span>
    <span style="color:#719e07">def</span> <span style="color:#268bd2">current_user</span>
        @current_user <span style="color:#719e07">||=</span> <span style="color:#cb4b16">User</span><span style="color:#719e07">.</span>find_by(<span style="color:#b58900">id</span>: session<span style="color:#719e07">[</span><span style="color:#2aa198">:user_id</span><span style="color:#719e07">]</span>)
    <span style="color:#719e07">end</span>
     
     
    <span style="color:#719e07">def</span> <span style="color:#268bd2">logged_in?</span>
        <span style="color:#719e07">!</span>current_user<span style="color:#719e07">.</span>nil?
        <span style="color:#586e75"># ログイン中の状態＝セッションにユーザーが存在する＝current_userがnilでない状態。</span>
    <span style="color:#719e07">end</span>
     
    <span style="color:#719e07">def</span> <span style="color:#268bd2">log_out</span>
        session<span style="color:#719e07">.</span>delete(<span style="color:#2aa198">:user_id</span>)　<span style="color:#586e75">#セッションからユーザーIDを削除</span>
        @current_user <span style="color:#719e07">=</span> <span style="color:#719e07">nil</span>　　　　<span style="color:#586e75">#現在のユーザーをnilに設定</span>
    <span style="color:#719e07">end</span>
<span style="color:#719e07">end</span>
</code></pre></div><p>ログイン機能の実装完了！</p>
<h1 id="まとめ">まとめ</h1>
<p>本当に必要最低限なユーザー認証を実装してみましたが、これらをコマンドひとつで解決してくれるdeviseは本当に便利</p>
<p>ただ、自分で機能をカスタマイズしたい時はその裏の動きを理解しなければならないので
gemを使わずに実装してみることの重要さも理解できました！</p>

		</div>

		<div class="post-tags">
			
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © Copyright m-88888888 |  <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-192108063-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>feather.replace()</script>
</body>
</html>
