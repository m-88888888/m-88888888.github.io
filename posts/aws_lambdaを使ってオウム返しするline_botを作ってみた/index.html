<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>【Go言語】AWS Lambdaを使ってオウム返しするLINE Botを作ってみた - hachi&#39;s blog</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="【Go言語】AWS Lambdaを使ってオウム返しするLINE Botを作ってみた" />
<meta property="og:description" content="最近学習中のGo言語とLambdaで何か作ってみたかったので、Lambdaを使ったLINE　Botに挑戦してみた。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://m-88888888.github.io/posts/aws_lambda%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%82%AA%E3%82%A6%E3%83%A0%E8%BF%94%E3%81%97%E3%81%99%E3%82%8Bline_bot%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%81%9F/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-30T22:20:19+09:00" />
<meta property="article:modified_time" content="2020-09-30T22:20:19+09:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="【Go言語】AWS Lambdaを使ってオウム返しするLINE Botを作ってみた"/>
<meta name="twitter:description" content="最近学習中のGo言語とLambdaで何か作ってみたかったので、Lambdaを使ったLINE　Botに挑戦してみた。"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://m-88888888.github.io/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://m-88888888.github.io/css/main.css" /><link rel="stylesheet" type="text/css" href="https://m-88888888.github.io/css/dark.css" media="(prefers-color-scheme: dark)" />

	<script src="https://m-88888888.github.io/js/feather.min.js"></script>
	
	<script src="https://m-88888888.github.io/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://m-88888888.github.io/">
	<h1 class="site-title"><a href="https://m-88888888.github.io/">hachi&#39;s blog</a></h1>
	<div class="site-description"><h2>いろいろアウトプット</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/m-88888888" title="Github"><i data-feather="github"></i></a><a href="https://twitter.com/hachi88_10" title="Twitter"><i data-feather="twitter"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">【Go言語】AWS Lambdaを使ってオウム返しするLINE Botを作ってみた</h1>
			<div class="meta">Posted at &mdash; Sep 30, 2020</div>
		</div>

		<div class="markdown">
			<p>最近学習中のGo言語とLambdaで何か作ってみたかったので、Lambdaを使ったLINE　Botに挑戦してみた。</p>
<h2 id="bot概要">Bot概要</h2>
<ul>
<li>LINEでメッセージをオウムがえしして返答するチャットボット</li>
</ul>
<h2 id="構成図">構成図</h2>
<p><img src="https://user-images.githubusercontent.com/51853475/94694865-3f690600-0370-11eb-988f-f182d42f6ff0.png" alt="AWS Icons"></p>
<h2 id="aws設定">AWS設定</h2>
<p>Lambdaの設定についてはぐぐれば出てくるので省略。</p>
<h2 id="処理の流れ">処理の流れ</h2>
<ol>
<li>API Gatewayからイベントリクエストを受け取る</li>
<li>リクエスト内のBody部にあるJSON文字列をデコードする</li>
<li>LINE SDKを用いてBotを定義する（トークンなどの情報は環境変数として保持）</li>
<li>応答メッセージを生成、ここではオウム返しするため送信されたメッセージをそのまま応答メッセージとして設定する</li>
<li>ステータスコードを返却して処理を終了</li>
</ol>
<h2 id="コード">コード</h2>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#719e07">package</span> main

<span style="color:#719e07">import</span> (
	<span style="color:#2aa198">&#34;encoding/json&#34;</span>
	<span style="color:#2aa198">&#34;fmt&#34;</span>
	<span style="color:#2aa198">&#34;github.com/aws/aws-lambda-go/events&#34;</span>
	<span style="color:#2aa198">&#34;github.com/aws/aws-lambda-go/lambda&#34;</span>
	<span style="color:#2aa198">&#34;github.com/line/line-bot-sdk-go/linebot&#34;</span>
	<span style="color:#2aa198">&#34;log&#34;</span>
	<span style="color:#2aa198">&#34;os&#34;</span>
)

<span style="color:#268bd2">func</span> <span style="color:#268bd2">main</span>() {
	<span style="color:#586e75">// Lambda関数のエントリポイント
</span><span style="color:#586e75"></span>	lambda.<span style="color:#268bd2">Start</span>(HandleRequest)
}

<span style="color:#268bd2">func</span> <span style="color:#268bd2">HandleRequest</span>(request events.APIGatewayProxyRequest) (events.APIGatewayProxyResponse, <span style="color:#dc322f">error</span>) {

	<span style="color:#586e75">// LINEプラットフォームで生成されたWebhookオブジェクト
</span><span style="color:#586e75"></span>	fmt.<span style="color:#268bd2">Println</span>(<span style="color:#2aa198">&#34;=== Body ===&#34;</span>)
	fmt.<span style="color:#268bd2">Println</span>(request.Body)

	<span style="color:#586e75">// JSONをデコード
</span><span style="color:#586e75"></span>	fmt.<span style="color:#268bd2">Println</span>(<span style="color:#2aa198">&#34;=== JSON decode ===&#34;</span>)
	myLineRequest, err <span style="color:#719e07">:=</span> <span style="color:#268bd2">UnmarshalLineRequest</span>([]<span style="color:#b58900">byte</span>(request.Body))
	<span style="color:#719e07">if</span> err <span style="color:#719e07">!=</span> <span style="color:#cb4b16">nil</span> {
		log.<span style="color:#268bd2">Fatal</span>(err)
	}

	<span style="color:#586e75">// ボットの定義
</span><span style="color:#586e75"></span>	fmt.<span style="color:#268bd2">Println</span>(<span style="color:#2aa198">&#34;=== linebot new ===&#34;</span>)
	bot, err <span style="color:#719e07">:=</span> linebot.<span style="color:#268bd2">New</span>(
		os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;LINE_CHANNEL_SECRET&#34;</span>),
		os.<span style="color:#268bd2">Getenv</span>(<span style="color:#2aa198">&#34;LINE_CHANNEL_TOKEN&#34;</span>),
	)
	<span style="color:#719e07">if</span> err <span style="color:#719e07">!=</span> <span style="color:#cb4b16">nil</span> {
		log.<span style="color:#268bd2">Fatal</span>(err)
	}

	<span style="color:#586e75">// 応答メッセージの生成
</span><span style="color:#586e75"></span>	fmt.<span style="color:#268bd2">Println</span>(<span style="color:#2aa198">&#34;=== reply ===&#34;</span>)
	replyMessage <span style="color:#719e07">:=</span> myLineRequest.Events[<span style="color:#2aa198">0</span>].Message.Text
	<span style="color:#719e07">if</span> _, err = bot.<span style="color:#268bd2">ReplyMessage</span>(myLineRequest.Events[<span style="color:#2aa198">0</span>].ReplyToken, linebot.<span style="color:#268bd2">NewTextMessage</span>(replyMessage)).<span style="color:#268bd2">Do</span>(); err <span style="color:#719e07">!=</span> <span style="color:#cb4b16">nil</span> {
		log.<span style="color:#268bd2">Fatal</span>(err)
	}

	<span style="color:#586e75">// 終了
</span><span style="color:#586e75"></span>	fmt.<span style="color:#268bd2">Println</span>(<span style="color:#2aa198">&#34;=== end ===&#34;</span>)
	<span style="color:#719e07">return</span> events.APIGatewayProxyResponse{Body: request.Body, StatusCode: <span style="color:#2aa198">200</span>}, <span style="color:#cb4b16">nil</span>
}

<span style="color:#586e75">// API Gatewayから受け取ったevents.APIGatewayProxyResponseのBody（JSON）をParseする
</span><span style="color:#586e75"></span><span style="color:#268bd2">func</span> <span style="color:#268bd2">UnmarshalLineRequest</span>(data []<span style="color:#dc322f">byte</span>) (LineRequest, <span style="color:#dc322f">error</span>) {
	<span style="color:#268bd2">var</span> r LineRequest
	err <span style="color:#719e07">:=</span> json.<span style="color:#268bd2">Unmarshal</span>(data, <span style="color:#719e07">&amp;</span>r)
	<span style="color:#719e07">return</span> r, err
}

<span style="color:#268bd2">func</span> (r <span style="color:#719e07">*</span>LineRequest) <span style="color:#268bd2">Marshal</span>() ([]<span style="color:#dc322f">byte</span>, <span style="color:#dc322f">error</span>) {
	<span style="color:#719e07">return</span> json.<span style="color:#268bd2">Marshal</span>(r)
}

<span style="color:#268bd2">type</span> LineRequest <span style="color:#268bd2">struct</span> {
	Destination <span style="color:#dc322f">string</span>  <span style="color:#2aa198">`json:&#34;destination&#34;`</span>
	Events      []Event <span style="color:#2aa198">`json:&#34;events&#34;`</span>
}

<span style="color:#268bd2">type</span> Event <span style="color:#268bd2">struct</span> {
	ReplyToken <span style="color:#dc322f">string</span>   <span style="color:#2aa198">`json:&#34;replyToken&#34;`</span>
	Type       <span style="color:#dc322f">string</span>   <span style="color:#2aa198">`json:&#34;type&#34;`</span>
	Mode       <span style="color:#dc322f">string</span>   <span style="color:#2aa198">`json:&#34;mode&#34;`</span>
	Timestamp  <span style="color:#dc322f">int64</span>    <span style="color:#2aa198">`json:&#34;timestamp&#34;`</span>
	Source     Source   <span style="color:#2aa198">`json:&#34;source&#34;`</span>
	Message    <span style="color:#719e07">*</span>Message <span style="color:#2aa198">`json:&#34;message,omitempty&#34;`</span>
}

<span style="color:#268bd2">type</span> Message <span style="color:#268bd2">struct</span> {
	ID   <span style="color:#dc322f">string</span> <span style="color:#2aa198">`json:&#34;id&#34;`</span>
	Type <span style="color:#dc322f">string</span> <span style="color:#2aa198">`json:&#34;type&#34;`</span>
	Text <span style="color:#dc322f">string</span> <span style="color:#2aa198">`json:&#34;text&#34;`</span>
}

<span style="color:#268bd2">type</span> Source <span style="color:#268bd2">struct</span> {
	Type   <span style="color:#dc322f">string</span> <span style="color:#2aa198">`json:&#34;type&#34;`</span>
	UserID <span style="color:#dc322f">string</span> <span style="color:#2aa198">`json:&#34;userId&#34;`</span>
}
</code></pre></div><h3 id="ポイント">ポイント</h3>
<ul>
<li>API GatewayのイベントリクエストをLINE SDKを使用せずに自分でパースしてる。
<ul>
<li>LINE SDKで用意しているパースメソッド<code>ParseRequest()</code>は<code>*http.Request</code>を引数に渡す必要があるけど、lambdaがAPI Gatewayから受け取るイベントの型が対応していないから。</li>
</ul>
</li>
</ul>
<h2 id="ハマった点">ハマった点</h2>
<ul>
<li>ポイントでも紹介した通り、リクエストをパースする処理で詰まってた。<code>ParseRequest()</code>をオーバーライドするか、自分でパース処理を書くか。今回は初めてだったので自分でパース処理を書いた。</li>
</ul>
<h2 id="今後の課題">今後の課題</h2>
<ul>
<li>チャット以外送信したときの処理がないｌ
<ul>
<li>スタンプや画像、動画などを送信された時にも応答メッセージを送る</li>
</ul>
</li>
<li>lambdaから他のAWSサービスを利用する処理を追加したい。
<ul>
<li>例&gt;画像が送信されたらS3に保存する</li>
</ul>
</li>
</ul>
		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/golang">golang</a></li>
								
								<li><a href="/tags/aws">aws</a></li>
								
								<li><a href="/tags/linebot">linebot</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'localhost';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © Copyright m-88888888 |  <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-192108063-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>feather.replace()</script>
</body>
</html>
