---
title: "マスタリングTCP/IP入門編を読んでみた"
date: 2021-08-23T00:32:12+09:00
draft: false
---

普段の業務はWebアプリケーションの開発がメインなのですが、ネットワーク周りのトラブルが発生した時の原因を調査するための前提知識が足りていないと感じていました。

そこで、いつかは読みたいと思っていたネットワークの入門書で有名な`マスタリングTCP/IP　入門編　第6版`を読んでみました。

![2000007974462](https://user-images.githubusercontent.com/51853475/130361395-1ea8f6ee-fb0b-4326-8aa9-775bd1fccab4.jpg)


## 読書ノート
```md
# 1章　ネットワーク基礎知識
- コンピュータ間通信からコンピュータネットワーク、インターネットへと情報通信ネットワークが形成されていった
- コンピュータ間の通信の決まりごととして「プロトコル」がISOによって「OSI参照モデル」が定められた
- これに準拠することで異なるコンピュータのハードウェアやOSの違いを気にせず通信できるようになった
- OSI参照モデルは機能を7つの階層に分割することで、複雑になりがちなネットワーク・プロトコルを単純化させた
- 上位層→下位層の間のやり取りの決まりごとを「インタフェース」と呼ぶ
- 通信相手と同じ階層とのやり取りの決まりごとを「プロトコル」と呼ぶ
- OSI参照モデルの各層の役割と機能イメージ
    - 物理層：0/1のビットを電圧の高低、光の点滅に変換
    - データリンク層：データフレームとビット列の変換。ネットワーク層は最終目的地までのデータ配達を、データリンク層は1区間のデータ配達を担う。
    - ネットワーク層：アドレスの管理と経路の選択。実際にデータを配達する役割
    - トランスポート層：ノード間のデータ転送の管理。ホスト間の論理的な通信手段の作成。
    - セッション層：コネクションの確立などの管理
    - プレゼンテーション層：ソフトウェア上の形式のデータをネットワーク共通のデータフォーマットに相互変換
    - アプリケーション層：アプリケーションごとのプロトコル。処理全体の最初と最後の部分を実行
- 通信方式の種類と用途
    - コネクション型：送信側、受信側双方のホスト間で確立してからデータ送信する
    - コネクションレス型：受信側の都合を考慮せず一方的にデータを送信する
        - 確立せず送信できるので、通信速度向上・電波状況が悪いときなどの低品質の通信の継続などに使われる
- コンピュータ→交換器→コンピュータという流れで回線を接続していた回線交換方式は、コネクションを確立した回線を占有してしまう。そこで、データをパケットとして細分化して各コンピュータが一斉に送受信できるようになった（パケット交換）
    - パケット交換器＝ルーター。
    - 回線を占有する方法から、データを分割して回線を共有する方法に変えた。
    - パケット交換の場合、通常コンピュータ→ルーター間は回線が1つだけなので、この回線を共有することになる。そうするとネットワークの混雑度によってパケットの到着間隔が前後したり、ルーターのバッファ（パケットを一旦格納する場所）があふれるとパケットが喪失する恐れがある。「インターネット速度が遅い」と言われる減少はこのこと？
- IPアドレスにも現実の住所などと同じように「階層性」が必要
    - ネットワーク部・ホスト部という階層を持つ
    - ※MACアドレスには階層性はない

# 2章　TCP/IP基礎知識
- TCP/IPの階層（OSI参照モデルの階層）
    - ハードウェア（物理層）：物理回線のこと。利用できる通信媒体に制限はない
    - ネットワークインタフェース層（データリンク層）：デバイスドライバのこと
    - インターネット層（ネットワーク層）：IPのこと。IPはIPアドレスを識別子として使ってネットワークをまたいでパケットを送信するプロトコル。
        - IPはパケットが相手に到達しなくても再送しない
        - ICMPは相手に到達しない場合、送信元に異常を知らせてくれる。ネットワーク診断などに使われる
        - ARP：IPアドレスから送り先の物理的なアドレス（MACアドレス）を取得するプロトコル
    - トランスポート層（トランスポート層）：ポート番号を使ってアプリケーションプログラム間の通信を実現するための階層。
        - TCP：コネクション型。
        - UDP：コネクションレス型。音声・映像データなどの場合に利用される
    - アプリケーション層（セッション層↑の上位層）：セッション〜プレゼンテーション〜アプリケーション層はすべてアプリケーションプログラムの中で実現される。
- 通信の流れ：各層で送信されるデータにヘッダを付加していき、受信側が同じ層でヘッダを解釈していく。
    - 電子メールの例。p212の図がわかりやすい
    - パケットの構造イメージ。p215がわかりやすい
        - 各層でMACアドレス・IPアドレス・ポート番号の送信元・送信先をヘッダに付加しているイメージ。
        - データが壊れていないことも確認している。

# 3章　データリンク
- データリンク層の技術を使った通信媒体についての紹介
- 今の所あんまり興味ないので、さらっと目を通してスキップ

# 4章　IP
- 「IP」というプロトコルが、IPアドレス、IPパケットなど色んな言葉に使われていて「IP」単体だと誤解されがちなので、「the IP protocol」、「IPプロトコル」と表現されるケースがある
- ネットワーク層とデータリンク層の関係は、旅の行程表と航空券や切符の関係性に似ている
    - ネットワーク層は最終目的地までの通信、つまり旅の最終目的地。そこまでの通信（旅行）を実現する
    - データリンク層は通信の1区間の通信、旅行で移動する時に飛行機を使って羽田空港〜新千歳空港までの航空券に該当する。つまり、最終目的地までの通信の1単位。
- IPアドレスは、データリンクの性質を抽象化しているので、同じIPアドレスでネットワークの運用管理をできるようにする役割を持っている
- ルーティングは、ホストorルーターがIPパケットをどこに転送するのかを指示する。転送先は最終目的地を直接指示しているわけではなく、ネットワークの各区間ごとに個々のルーターが持つルーティングテーブルと呼ばれる転送先の表を見て、転送先を決めている。この作業を繰り返すことで最終的な目的地まで通信できている。
- IPはデータリンクの性質を抽象化するので、通信形式が無線LAN or 有線LANなど、一度に送信できる通信量に差が生じる場合に、一度に送信しきれないIPパケットを分割処理（フラグメンテーション）を行う必要がある。
- IPは機能の簡略化・高速化のためにコネクションレス型。コネクション型が必要な場合はIPよい上位の層で対応すれば良い
- IPアドレスのネットワーク部・ホスト部の切れ目をサブネットマスクを使って判断できるようにした
    - サブネットマスクのビットが「１」の部分がネットワーク部、「０」の部分がホスト部
- ネットワーク部・ホスト部の桁数が決められたクラスではなく、自分たちで任意の桁数に変更するための仕組みが「CIDR」

# 5章　IPに関する技術
- ARPANET時代は、**hosts**というホスト名とIPアドレスの対応を定義したデータベースファイルが利用されていた。hostsの中身は携帯電話の連絡先みたいなもの。ホスト名が相手の名前、IPアドレスが電話番号
- hostsを一括管理していたが、ネットワークの規模が大きくなるにつれ管理が難しくなった
- ホスト管理している組織の単位でhostsみたいなデータベースを管理するための手段が**DNS**
    - ホスト名、IPアドレスの変更がある度にhostsを管理する機関に報告や申請する必要がなくなった。
    - ダイナミックDNS・・・IPアドレスが変化しても同じホスト名を利用できる
- ドメイン名の構造はツリー構造になっている　P439
    - 例：kusa.ac.jp
        - kusa・・・
        - ac・・・分野別トップレベルドメイン（gTLD）
        - jp・・・国コードトップレベルドメイン（ccTLD）
- ネームサーバー：上記のドメイン構造の各階層で設置されており、自分の階層のドメイン名を管理しているホスト・ソフトウェアのこと
    - ネームサーバーは下の階層のIPアドレス、ルートネームサーバーのIPアドレスを知っているので、ルートから順番にたどることで世界中のネームサーバーにアクセスできる
- リゾルバ（Resolver）：DNSに問い合わせするホスト・ソフトウェアのこと。ユーザーの利用するPCがリゾルバに該当する。
- DNS問い合わせの処理（query）　P445
    - ルートネームサーバーに対象ホストの所属するネームサーバーのIPアドレスを聞きに行く
    - 木構造の上から順番にたどる
- DNSはホスト名→IPアドレスを検索するだけではなく、ホスト名→IPアドレス、上位・下位のネームサーバーのIPアドレスなどの情報も保持している。　P447
- ARP：IPで宛先IPアドレスにデータリンクを使って通信するときにはMACアドレスも必要。このMACアドレスをIPアドレスから知りたい時に使われるプロトコル。
    - ARPはIPv4でのみ利用
    - IPv6はARPの代わりにICMPv6を利用
- ARPの仕組み　P449
    - ホストAがホストBのMACアドレスを知りたい
        - ホストAがARP要求パケットというパケットで、ホストBのIPアドレスをブロードキャスト（同一リンクのすべてのホストに通信）する
        - ブロードキャストされたパケットをすべてのホストが受取る
        - すべてのホストがARP要求パケットの中の目的のIPアドレスが自分のIPアドレスに一致する
        - 自分のMACアドレスを埋めたARP応答パケットをホストA宛に返送する
        - 一度取得したMACアドレスは数分間キャッシュされる

        ```sh
        $ apa
        Address                  HWtype  HWaddress           Flags Mask            Iface
        192.168.11.26            ether   16:53:4c:ba:9c:89   C                     wlp1s0
        _gateway                 ether   18:ec:e7:6d:b2:78   C                     wlp1s0
        192.168.11.5             ether   dc:91:bf:03:cf:19   C                     wlp1s0
        ```

- ネットワークの通信の最終目的地はMACアドレスなので、MACアドレスだけわかれば通信できるのでは？
    - IPアドレスがないとどうなるかを考えてみる
        - インターネットはネットワークが複数絡み合うことで構築されている。このネットワークの始端を各ネットワークのホストを管理しているルーターが担っている。
        - 異なるネットワークのホストのMACアドレスだけを知っても、そのホストがどのネットワークにいるのかがわからない。
        - ネットワークを特定するために、各ネットワークのルーターが「次のルーター」を知る役割を持っている
        - なので、IPアドレスが宛先ホストの存在するネットワークを特定するために必要不可欠
- RARP：ARPの逆。MACアドレスからIPアドレスを知りたい場合に使う
- GARP：自分のIPアドレスに対するMACアドレスを知りたい場合に使う。IPアドレスの重複の確認に使われる
- Proxy ARP：本来の問い合わせ先に代わってARP応答する機能
- ICMP：IPパケットが目的地まで到達したかどうかを通知してくれる
    - ICMPv6：IPv4のARPの代わりにICMPを使ってIPアドレス→MACアドレスを調べる
- DHCP：コンピュータをネットワークに接続するだけでTCP/IP通信ができるようになるための仕組み。プラグ＆プレイが実現される。
    - 本来、TCP/IP通信のためにはホストごとにIPアドレスを設定する必要がある。その設定を自動化してくれる役割を持つ。
- NAT（Network Address Translator）：ローカルネットワークのプライベートIPアドレスとインターネットへ接続するときに使うグローバルIPアドレスを変換する技術。

# 6章　TCPとUDP
- トランスポートプロトコルの代表的なものがTCPとUDP
    - TCP：信頼性のある通信。コネクション型。ストリーム型。ふくそう制御。再送機能。
    - UDP：同報通信（マルチキャスト、ブロードキャストのこと）。コネクションレス型。
- IPヘッダにはプロトコルフィールド、どのトランスポートプロトコルにデータを渡すかが定義されている。これと同様にトランスポート層のTCP・UDPでも次にどのアプリケーションにデータを渡すかが定義されている。これが**ポート番号**
    - ポート番号はプログラムのアドレス、とも言える
- トランスポート層は、データを渡すプログラムを指定する役割を持つ
- デーモン（Daemon）：常時起動されていて特定の処理を実行するプログラムのこと
    - httpd（HTTPデーモン）：HTTPのサーバープログラム
    - sshd（sshデーモン）：sshのサーバープログラム
    - inetd（インターネットデーモン）：複数のデーモンの代表としてクライアントの要求を受け付けるスーパーデーモン。要求を受けるとsshdなどのデーモンに返信する
- TCPとUDPの使い分け
    - 人と人が対話するIP電話の場合
        - TCPはデータがロスしたら再送処理を行うので、音声の再生がスムーズにいかない
        - UDPは多少データをロスしても再送処理をしないので、音声が遅れて届く。みたいなことはない。多少パケットがロスしても一時的に音声が乱れるだけ。
    - UDPはふくそう制御がないので、インターネットでの高品質な通信が難しい
- ソケット：OSが持っているTCP/IPの機能をAPIとして提供してくれる
- TCP,UDPそれぞれ同じポート番号を使うことができる。なぜならポート番号の処理がトランスポートプロトコルごとに行われるから。
- UDP（User Datagram Protocol）
    - アプリケーション側に通信制御を任せるため、複雑な制御をせずに通信できる
    - プログラマーの思い通りにプログラミングできるデータグラムプロトコル
    - その分、プログラマーが上位層のプロトコルを考慮してアプリケーションを作成する必要がある
- TCP（Transmission Control Protocol）
    - ふくそう制御とか、通信の信頼性を高めるための仕組みが多い感じ。全部は読みきれてない
- QUIC
    - HTTP/3の基盤となる新たなトランスポートプロトコル
    - UDPと合わせて1つのトランスポートプロトコルとしての役割を提供する
    - TCP自体には暗号化の機能はなかったが、QUICはそれ自体で暗号通信ができる

## 気になったこと

- ポート番号って上限とかあるの？ダイナミックな割当法だと49152〜65535までの整数が利用される。っていっているけど、10000000000000みたいなポート番号も使えたりするの？
    - TCPのポート番号が16ビットだから、上限が65535

# 7章　ルーティングプロトコル
- 流し読み

# 8章　アプリケーションプロトコル
- 流し読み

# 9章　セキュリティ
- 流し読み

```

## 感想

- 1章、2章、4章、5章、6章あたりが特に勉強になった。
- TCP/IPの階層とその役割を理解する上で、OSI参照モデルがベースになっているので非常にイメージがしやすい。
- TCP、UDPとかプロトコルが存在していることは知っていたが、それらがなぜ必要でどのように使われているのかを理解したことで、TCP/IPの通信の動きが少しわかってきた気がする
- 7〜9章はあんまりメモ取らずに読んでしまったのでまた今度見返したい
- ソケットプログラミングちょっと興味ある。golangでTCPクライアント作って3-way-handshakeの動きを確認してみるのも良さそう
- アプリケーション層のプロトコルであるhttpを支えるプロトコルの動きがおおまかだけど理解できたので、次はhttpそのもののプロトコルをもう一歩深堀りしていきたい